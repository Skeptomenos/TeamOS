#!/bin/bash
# Pre-commit hook: PII Scanner
# Prevents commits containing personal identifiable information

set -e

# Define PII patterns to block (case-insensitive)
# Add your own patterns here
PII_PATTERNS=(
    "david"
    "helmus"
    "hellofresh"
    # Add more patterns as needed
)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running PII scan...${NC}"

# Get list of staged files (excluding binary files and this hook)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|tf|sh|py|json|yaml|yml|txt|example|js|ts|html|css)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No text files staged. Skipping PII scan.${NC}"
    exit 0
fi

FOUND_PII=0

for pattern in "${PII_PATTERNS[@]}"; do
    # Search for pattern in staged files (case-insensitive)
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -l -i "$pattern" 2>/dev/null || true)
    
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}ERROR: Found PII pattern '$pattern' in:${NC}"
        for file in $MATCHES; do
            echo -e "  ${RED}→ $file${NC}"
            # Show the matching lines
            grep -n -i "$pattern" "$file" | head -5 | while read line; do
                echo -e "    ${YELLOW}$line${NC}"
            done
        done
        FOUND_PII=1
    fi
done

if [ $FOUND_PII -eq 1 ]; then
    echo ""
    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  COMMIT BLOCKED: PII detected in staged files              ║${NC}"
    echo -e "${RED}║                                                            ║${NC}"
    echo -e "${RED}║  Please remove personal information before committing.     ║${NC}"
    echo -e "${RED}║  Use generic placeholders like:                            ║${NC}"
    echo -e "${RED}║    - example.com instead of company domains                ║${NC}"
    echo -e "${RED}║    - admin@example.com instead of real emails              ║${NC}"
    echo -e "${RED}║    - 'Your Name' instead of real names                     ║${NC}"
    echo -e "${RED}║                                                            ║${NC}"
    echo -e "${RED}║  To bypass (NOT RECOMMENDED):                              ║${NC}"
    echo -e "${RED}║    git commit --no-verify                                  ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    exit 1
fi

echo -e "${GREEN}✓ PII scan passed. No sensitive patterns found.${NC}"
exit 0
